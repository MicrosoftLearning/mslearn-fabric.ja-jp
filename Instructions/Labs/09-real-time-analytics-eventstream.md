---
lab:
  title: Microsoft Fabric の Eventstream に関する概要
  module: Get started with Eventstream in Microsoft Fabric
---
# Microsoft Fabric の Eventstream に関する概要

Eventstream とは、コードなしのエクスペリエンスでリアルタイム イベントをキャプチャし、変換し、さまざまな宛先にルーティングする Microsoft Fabric の機能です。 変換が必要な場合は、イベントのデータ ソース、ルーティング先、イベント プロセッサを Eventstream に追加できます。 Microsoft Fabric の EventStore は、クラスターからのイベントを維持し、特定の時点でのクラスターまたはワークロードの状態を理解できるようにする監視オプションです。 EventStore サービスでは、クラスター内のエンティティとエンティティ型のそれぞれで使用できるイベントのクエリを実行できます。 つまり、クラスター、ノード、アプリケーション、サービス、パーティション、パーティション レプリカなど、さまざまなレベルのイベントにクエリを実行できます。 EventStore サービスは、クラスター内のイベントを関連付ける機能も備えています。 EventStore サービスは、相互に影響を与えた可能性がある異なるエンティティから同時に書き込まれたイベントを調べてそれらのイベントをリンクし、クラスター内で発生したアクティビティの原因の識別に役立てることができます。 Microsoft Fabric クラスターの監視と診断を行うもう 1 つのオプションが、EventFlow を使用したイベントの集計と収集です。

このラボの所要時間は約 **30** 分です。

> **注**:この演習を完了するには、[Microsoft Fabric 試用版](https://learn.microsoft.com/fabric/get-started/fabric-trial)が必要です。

## ワークスペースの作成

Fabric でデータを操作する前に、Fabric 試用版を有効にしてワークスペースを作成してください。

1. `https://app.fabric.microsoft.com/home?experience=fabric` で [Microsoft Fabric ホーム ページ](https://app.fabric.microsoft.com/home?experience=fabric)にサインインし、**[Power BI]** を選択します。
2. 左側のメニュー バーで、 **[ワークスペース]** を選択します (アイコンは &#128455; に似ています)。
3. 任意の名前で新しいワークスペースを作成し、Fabric 容量を含むライセンス モード ("試用版"、*Premium*、または *Fabric*) を選択してください。**
4. 新しいワークスペースを開くと次に示すように空のはずです。

   ![Power BI の空のワークスペースのスクリーンショット。](./Images/new-workspace.png)
5. Power BI ポータルの左下で、**[Power BI]** アイコンを選択し、**リアルタイム インテリジェンス** エクスペリエンスに切り替えます。

## リアルタイム インテリジェンス イベントハウスを作成する

1. Microsoft Fabric のリアルタイム インテリジェンスのホーム ページで、任意の一意の名前で新しい**イベントハウス**を作成します。
1. 新しい空のイベントハウスが表示されるまで、表示されているヒントまたはプロンプトを閉じます。

    ![新しいイベントハウスのスクリーンショット](./Images/create-eventhouse.png)

## KQL データベースを作成する

1. **[リアルタイム インテリジェンス イベントハウス]** ダッシュボード内で、**[KQL データベース +]** ボックスを選択します。
1. **新しいデータベース (既定)** を作成するか、**新しいショートカット データベース (フォロワー)** を作成する選択肢があります。

    >**注:** フォロワー データベース機能により、別のクラスターにあるデータベースを Azure Data Explorer クラスターにアタッチできます。 フォロワー データベースは "読み取り専用" モードでアタッチされるため、データを表示したり、リーダー データベースに取り込まれたデータに対してクエリを実行したりできます。 フォロワー データベースには、リーダー データベースの変更が同期されます。 この同期により、データが利用可能になるまでに数秒から数分のデータ遅延が発生します。 遅延の長さは、リーダー データベースのメタデータ全体のサイズに応じて異なります。 リーダー データベースとフォロワー データベースでは、データをフェッチするために同じストレージ アカウントが使用されます。 ストレージを所有するのはリーダー データベースです。 フォロワー データベースでは、データを取り込むことなくデータを表示できます。 アタッチされたデータベースは読み取り専用のデータベースであるため、データベース内のデータ、テーブル、およびポリシーの変更はできませんが、キャッシュ ポリシー、プリンシパル、およびアクセス許可の変更は可能です。

1. 新しいデータベースを作成し、名前を「`Eventhouse-DB`」にします。

## Eventstream を作成する

1. KQL データベースのメイン ページで、 **[データの取得]** を選択します。
2. データ ソースで、**[Eventstream** > **新しい Eventstream]** を選択します。 Eventstream `bicycle-data` に名前を付けます。

    ワークスペース内での新しいイベント ストリームの作成はすぐに完了します。 確立が完了すると、プライマリ エディターに自動的にリダイレクトされ、ソースをイベント ストリームに統合する準備が整います。

    ![新しい Eventstream のスクリーンショット。](./Images//name-eventstream.png)

## Eventstream ソースを確立する

1. Eventstream キャンバスで、**[サンプル データの使用]** を選択します。
2. ソース `Bicycles` に名前を付けて、**[Bicycles]** サンプル データを選択します。

    ストリームがマップされ、**Eeventstream キャンバス**に自動的に表示されます。

   ![Eventstream キャンバスの確認](./Images/real-time-intelligence-eventstream-sourced.png)

## 宛先の追加

1. **変換イベントまたは変換先を追加する**ドロップダウン リストで、**Eventhouse** を選択します。
1. **Eventhouse** ペインで、次のセットアップ オプションを構成します。
   - **データ インジェスト モード:** インジェスト前イベント処理
   - **変換先の名前:**`Bicycle-database`
   - **ワークスペース: ***この演習の開始時に作成したワークスペースを選択します*
   - **Eventhouse**: *イベントハウスを選択します*
   - **KQL データベース:** Eventhouse-DB
   - **変換先テーブル:** `bike-count` という名前の新しいテーブルを作成します
   - **入力データ形式:** JSON

   ![KQL データベース Eventstream とインジェスト モード](./Images/kql-database-event-processing-before-ingestion.png)

1. **Eventhouse** ペインで、**[保存]** を選択します。 
1. ツールバーの **[発行]** を選択します。
1. データ変換先がアクティブになるまで 1 分ほど待ちます。

## キャプチャされたデータを表示する

作成した Eventstream は、bicycle データのサンプル ソースからデータを取得し、Eventhouse 内のデータベースに読み込みます。 データベース内のテーブルに対してクエリを実行すると、キャプチャされたデータを表示できます。

1. 左側のメニュー バーで、**Eventhouse-DB** データベースを選択します。
1. **Eventhouse-DB** KQL データベースの **...** メニューで、**[クエリ データ]** を選択します。
1. クエリ ペインで、次に示すように最初のクエリ例を変更します。

    ```kql
    ['bike-count']
    | take 100
    ```

1. クエリ コードを選択して実行し、テーブルの 100 行のデータを表示します。

    ![KQL クエリのスクリーンショット。](./Images/kql-query.png)

## イベント データを変換する

キャプチャしたデータはソースから変更されていません。 多くのシナリオでは、イベント ストリーム内のデータを変換先に読み込む前に変換することができます。

1. 左側のメニュー バーで、**Bicycle-data** Eventstream を選択します。
1. ツール バーで **[編集]** を選択して、Eventstream を編集します。

1. **[変換イベント]** メニューで、**[グループ化]** を選択して、Eventstream に新しい**グループ化**ノードを追加します。
1. 接続を **Bicycle-data** ノードの出力から新しい**グループ化**ノードの入力にドラッグし、**グループ化**ノードの*鉛筆*アイコンを使用して編集します。

   ![変換イベントにグループ化を追加します。](./Images/eventstream-add-aggregates.png)

1. **グループ化**設定セクションのプロパティを次のように構成します。
    - **操作名:** GroupByStreet
    - **集計の種類:** Sum を*選択*します
    - **フィールド:** No_Bikes を*選択*します。 *次に、**[追加]** を選択して次の関数を作成します: *SUM_No_Bikes
    - **次で集計をグループ化 (オプション):** Street
    - **時間ウィンドウ**: タンブリング
    - **期間**: 5 秒
    - **オフセット**: 0 秒

    > **注**: この構成により、Eventstream は各道路の自転車の合計数を 5 秒ごとに計算します。
      
1. 構成を保存し、エラーが示されている Eventstream キャンバスに戻ります (変換によってグループからの出力をどこかに格納する必要があるため)。

1. **GroupByStreet** ノードの右側にある **+** アイコンを使用して、新しい **Eventhouse** ノードを追加します。
1. 次のオプションを使用して、新しい Eventhouse ノードを構成します。
   - **データ インジェスト モード:** インジェスト前イベント処理
   - **変換先の名前:**`Bicycle-database`
   - **ワークスペース: ***この演習の開始時に作成したワークスペースを選択します*
   - **Eventhouse**: *イベントハウスを選択します*
   - **KQL データベース:** Eventhouse-DB
   - **変換先テーブル:** `bikes-by-street` という名前の新しいテーブルを作成します
   - **入力データ形式:** JSON

   ![グループ化したデータのテーブルのスクリーンショット。](./Images/group-by-table.png)

1. **Eventhouse** ペインで、**[保存]** を選択します。 
1. ツールバーの **[発行]** を選択します。
1. 変更がアクティブになるまで 1 分ほど待ちます。

## 変換されたデータを表示する

これで、Eventstream によって変換されてテーブルに読み込まれた bicycle のデータを表示できるようになりました

1. 左側のメニュー バーで、**Eventhouse-DB** データベースを選択します。
1. **Eventhouse-DB** KQL データベースの **...** メニューで、**[クエリ データ]** を選択します。
1. クエリ ペインで、次に示すようにクエリ例を変更します。

    ```kql
    ['bikes-by-street']
    | take 100
    ```

1. クエリ コードを選択して実行し、テーブル内の最初の 100 行を表示します。

    ![KQL クエリのスクリーンショット。](./Images/kql-group-query.png)

    > **ヒント**: SQL 構文を使用してテーブルのクエリを実行することもできます。 たとえば、クエリ `SELECT TOP 100 * FROM bikes-by-street` を実行してみます。

## リソースをクリーンアップする

この演習では、Eventstream を使用して、イベントハウスを作成し、そのデータベースにテーブルを設定しました。

KQL データベースの探索が完了したら、この演習用に作成したワークスペースを削除できます。

1. 左側のバーで、ワークスペースのアイコンを選択します。
2. ツール バーの **[ワークスペース設定]** を選択します。
3. **[全般]** セクションで、**[このワークスペースの削除]** を選択します。
から始めます。
